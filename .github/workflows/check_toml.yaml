name: check_toml_version

on:
  workflow_call:
    inputs:
      pypi_package:
        required: true
        type: string
    outputs:
      uped_toml:
        description: "Whether pyproject.toml version differs from PyPI"
        value: ${{ jobs.check.outputs.uped_toml }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      uped_toml: ${{ steps.extract_update.outputs.uped_toml }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests

      - name: Get version from PyPI
        id: get_pypi_version
        run: |
          VERSION=$(curl -s https://pypi.org/pypi/${{ inputs.pypi_package }}/json | jq -r .info.version)
          echo "pypi_version=$VERSION" >> $GITHUB_ENV

      - name: Extract version from pyproject.toml
        id: extract_version
        run: |
          VERSION=$(grep -o 'version = ".*"' pyproject.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check for version update
        id: extract_update
        run: |
          if [ "${{ steps.extract_version.outputs.version }}" = "${{ env.pypi_version }}" ]; then
            echo "Version matches PyPI — no update"
            echo "uped_toml=false" >> $GITHUB_OUTPUT
          else
            echo "Version bumped — safe to publish"
            echo "uped_toml=true" >> $GITHUB_OUTPUT
          fi
