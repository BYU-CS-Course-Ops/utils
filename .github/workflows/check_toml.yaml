name: Check toml version

on:
  workflow_call:
    inputs:
      pypi_package:
        required: true
        type: string

jobs:
  check-toml-version:
    runs-on: ubuntu-latest
    outputs:
      mismatch: ${{ steps.mismatch.outputs.mismatch }}
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install PyPI package
        run: pip install "${{ inputs.pypi_package }}"

      - name: Extract version from pyproject.toml
        id: extract_version
        run: |
          VERSION=$(grep -o 'version = ".*"' pyproject.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get installed PyPI package version
        id: get_pypi_version
        run: |
          PYPI_PACKAGE_VERSION=$(pip show ${{ inputs.pypi_package }} | grep "^Version:" | awk '{print $2}')
          echo "pypi_version=$PYPI_PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Check for version mismatch
        id: mismatch
        run: |
          if [ "${{ steps.extract_version.outputs.version }}" = "${{ env.pypi_version }}" ]; then
            echo "Error: Version in pyproject.toml matches PyPI. Please update version."
            echo "mismatch=true" >> $GITHUB_OUTPUT
            exit 1
         else
            echo "mismatch=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
