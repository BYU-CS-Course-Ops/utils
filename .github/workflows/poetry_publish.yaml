name: poetry_build_publish

on:
  workflow_call:
    inputs:
      pypi_package:
        required: true
        type: string
    secrets:
      pypi_user:
        required: true
      pypi_password:
        required: true
      discord_webhook_url:
        required: true
      discord_role:
        required: true

jobs:
  check-toml-version:
    uses: ./.github/workflows/check_toml.yaml
    with:
      pypi_package: ${{ inputs.pypi_package }}
    secrets: inherit

  poetry-publish:
    needs: check-toml-version
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.publish.outputs.success }}
      version: ${{ needs.check-toml-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Poetry and Version Plugin
        run: pip install "poetry<2" poetry-version-from-file

      - name: Poetry Install
        run: poetry install

      - name: Build PyPI package
        run: poetry build

      - name: Publish PyPI package
        id: publish
        env:
          POETRY_PYPI_USERNAME: ${{ secrets.pypi_user }}
          POETRY_PYPI_PASSWORD: ${{ secrets.pypi_password }}
        run: |
          if [ "${{ needs.check-toml-version.outputs.uped_toml }}" != "true" ]; then
            echo "pyproject.toml version was not updated â€” skipping publish"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if poetry publish --username "$POETRY_PYPI_USERNAME" --password "$POETRY_PYPI_PASSWORD"; then
            echo "Publish succeeded"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "Publish failed"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  notify-discord:
    needs: [check-toml-version, poetry-publish]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout utils repo
        uses: actions/checkout@v4
        with:
          repository: BYU-CS-Course-Ops/utils
          path: utils

      - name: Install notification dependencies
        shell: bash
        run: pip install discord-webhook ${{ inputs.extra-packages }}

      - name: Send PyPI notification
        uses: utils/.github/actions/send-pypi-notification
        with:
          pypi-package: ${{ inputs.pypi_package }}
          success: ${{ needs.poetry-publish.outputs.success }}
          toml-updated: ${{ needs.check-toml-version.outputs.uped_toml }}
          version: ${{ needs.poetry-publish.outputs.version }}
          discord-role: ${{ secrets.discord_role }}
          discord-webhook-url: ${{ secrets.discord_webhook_url }}
